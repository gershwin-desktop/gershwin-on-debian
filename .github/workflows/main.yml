name: Build Debian Live ISO

on:
  push:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-iso:
    strategy:
      matrix:
        runner: [ubuntu-24.04, ubuntu-24.04-arm]
    runs-on: ${{ matrix.runner }}
    container:
      image: debian:latest
      volumes:
        - /proc:/proc
      options: --privileged
    name: Debian Live ISO Build (${{ matrix.runner }})
    steps:
      - name: Install dependencies
        run: |
          apt update
          apt install -y git sudo live-build curl

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure live-build
        run: |
          # Fix git ownership issue in container
          git config --global --add safe.directory /__w/gershwin-on-debian/gershwin-on-debian
          # Uncomment arch-specific entries
          arch=$(uname -m)
          sed -i "s/^#${arch} //g" config/package-lists/hardware.list.chroot
          # Pass git SHA to the build environment for deb versioning
          git_sha=$(git rev-parse --short HEAD)
          cat > config/hooks/normal/000-git-sha.chroot <<'EOFHOOK'
          #!/bin/bash
          export GIT_SHA="GIT_SHA_PLACEHOLDER"
          EOFHOOK
          sed -i "s/GIT_SHA_PLACEHOLDER/${git_sha}/g" config/hooks/normal/000-git-sha.chroot
          chmod +x config/hooks/normal/000-git-sha.chroot
          # Configure live-build
          lb config --debian-installer live \
                    --distribution bookworm \
                    --archive-areas "main contrib non-free non-free-firmware" \
                    --initramfs live-boot \
                    --mirror-bootstrap http://deb.debian.org/debian/ \
                    --mirror-chroot http://deb.debian.org/debian/ \
                    --mirror-binary http://deb.debian.org/debian/ \
                    --bootappend-live "boot=live components quiet splash"

      - name: Build the ISO
        run: |
          lb build
          iso_file=$(ls *.iso | head -n 1)
          date_str=$(date +%Y%m%d%H%M%S)
          arch=$(uname -m)
          mv "$iso_file" "gershwin-on-debian-${date_str}-${arch}.iso"

      - name: Extract deb package
        run: |
          # The deb package was extracted by the binary hook during ISO build
          # It should be in the gershwin-packages directory
          if [ -d gershwin-packages ]; then
            cp gershwin-packages/*.deb . || true
          fi
          ls -lh *.deb || echo "No deb packages found"

      - name: Upload files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          ls -lh *.iso
          ls -lh *.deb || echo "No deb packages to upload"
          wget -c https://raw.githubusercontent.com/probonopd/uploadtool/refs/heads/copilot/fix-release-deletion-issue/upload.sh
          # Upload ISO files
          bash upload.sh *.iso
          # Upload deb files if they exist
          if ls *.deb 1> /dev/null 2>&1; then
            bash upload.sh *.deb
          fi
